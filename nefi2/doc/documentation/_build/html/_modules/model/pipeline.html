

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>model.pipeline &mdash; nefi 2.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="nefi 2.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> nefi
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/Quick_Start_Guide_for_users.html">Quick Start Guide for users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/Quick_Start_Guide_for_developers.html">Quick Start Guide for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/Development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/Technologies.html">Dependencies</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">nefi</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>model.pipeline</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for model.pipeline</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains Pipeline class that represents a central control</span>
<span class="sd">mechanism over a sequential image processing pipeline. It controls all the</span>
<span class="sd">available image processing categories, handles processing results and works</span>
<span class="sd">as an mediator between the algorithms and UI.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">demjson</span>
<span class="kn">import</span> <span class="nn">networkx.readwrite</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">zope.event.classhandler</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithms&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">categories._category</span> <span class="kn">import</span> <span class="n">Category</span>
<span class="kn">from</span> <span class="nn">algorithms</span> <span class="kn">import</span> <span class="n">_utility</span>


<span class="n">__authors__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Pavel Shkadzko&quot;</span><span class="p">:</span> <span class="s2">&quot;p.shkadzko@gmail.com&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Dennis Gro√ü&quot;</span><span class="p">:</span> <span class="s2">&quot;gdennis91@googlemail.com&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Philipp Reichert&quot;</span><span class="p">:</span> <span class="s2">&quot;prei@me.com&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="filter_images"><a class="viewcode-back" href="../../rst_files/Autogen.html#model.pipeline.filter_images">[docs]</a><span class="k">def</span> <span class="nf">filter_images</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter out all non-image files.</span>
<span class="sd">    &lt;This function is used to protect the pipeline from attempting to process</span>
<span class="sd">    any non-image files existing in the input directory.&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_ext</span><span class="p">]</span></div>


<div class="viewcode-block" id="read_image_file"><a class="viewcode-back" href="../../rst_files/Autogen.html#model.pipeline.read_image_file">[docs]</a><span class="k">def</span> <span class="nf">read_image_file</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">prev_cat</span><span class="p">,</span> <span class="n">start_from</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read and return an image file as a numpy ndarray.</span>
<span class="sd">    If the name of the previous Category is Segmentation, read grayscaled img.</span>

<span class="sd">    Args:</span>
<span class="sd">        | *fpath* (str): file path</span>
<span class="sd">        | *prev_cat* (str): name of the previous Category</span>
<span class="sd">        | *start_from* (int): starting Category position</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prev_cat</span> <span class="o">==</span> <span class="s1">&#39;Segmentation&#39;</span> <span class="ow">and</span> <span class="n">start_from</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR in read_image_file() &#39;</span><span class="o">+</span>
              <span class="s1">&#39;Cannot read the image file, make sure it is readable&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="Pipeline"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline">[docs]</a><span class="k">class</span> <span class="nc">Pipeline</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">categories</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            | *categories* : OrderedDict of category names and their instances</span>
<span class="sd">            | *isui* (bool) : True if Pipeline is running in UI mode</span>

<span class="sd">        public Attributes:</span>
<span class="sd">            | *available_cats* (dict): dict of {Category name: Category}</span>
<span class="sd">            | *executed_cats* (list): a list of Categories in the pipeline</span>
<span class="sd">            | *pipeline_path* (str): a path to a saved pipelines</span>
<span class="sd">            | *out_dir* (str): a path where processing results are saved</span>
<span class="sd">            | *input_files* (list): a list of image files in the input dir</span>
<span class="sd">            | *cache* (list): a list of tuples where (Category name, img url)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_cats</span> <span class="o">=</span> <span class="n">categories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span>  <span class="c1"># default dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>  <span class="c1"># default out dir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_img</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># original image file as read first time</span>
        <span class="c1"># remember the results of each algorithm in the pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_memory</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Pipeline.subscribe_cache_event"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.subscribe_cache_event">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe_cache_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subscribe to the cache event which tells the maincontroller about</span>
<span class="sd">        new images in the cache folder</span>
<span class="sd">        Args:</span>
<span class="sd">            function: the subscriber</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_event</span><span class="o">.</span><span class="n">onChange</span> <span class="o">+=</span> <span class="n">function</span></div>

<div class="viewcode-block" id="Pipeline.subscribe_progress_event"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.subscribe_progress_event">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe_progress_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subscribe to the progress event which tells the maincontroller about</span>
<span class="sd">        the progress of the pipeline</span>
<span class="sd">        Args:</span>
<span class="sd">            function: the subscriber</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_event</span><span class="o">.</span><span class="n">onChange</span> <span class="o">+=</span> <span class="n">function</span></div>

<div class="viewcode-block" id="Pipeline.new_category"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.new_category">[docs]</a>    <span class="k">def</span> <span class="nf">new_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">cat_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alg_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used by the json parser to create a category.</span>
<span class="sd">        The parser knows already the cat type and alg type as well</span>
<span class="sd">        as the position. So it doesnt make sense to create a blank and</span>
<span class="sd">        change it.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *cat_name* (str): name of the category also indicating its cat type</span>
<span class="sd">            | *alg_name* (str): name of the active algoirthm indicating its alg type</span>
<span class="sd">            | *position* (int): position in the executed_cats</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># creating new blank Category</span>
        <span class="k">if</span> <span class="n">cat_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">blank_cat</span> <span class="o">=</span> <span class="n">Category</span><span class="p">(</span><span class="s2">&quot;blank&quot;</span><span class="p">)</span>
            <span class="n">blank_cat_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">blank_cat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">blank_cat_copy</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span>

        <span class="c1"># inserting named Category</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_cats</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">cat_name</span><span class="p">:</span>
                <span class="n">cat_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">cat_copy</span><span class="p">)</span>

        <span class="c1"># setting active Algorithm</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">available_algs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">alg_name</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">set_modified</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">set_active_algorithm</span><span class="p">(</span><span class="n">alg_name</span><span class="p">)</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="Pipeline.move_category"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.move_category">[docs]</a>    <span class="k">def</span> <span class="nf">move_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_pos</span><span class="p">,</span> <span class="n">destination_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move Category instance within the pipeline using indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *origin_pos* (int): Category index number</span>
<span class="sd">            | *destination_pos* (int): new position for Category</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">origin_pos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">origin_pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">destination_pos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">destination_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span></div>

<div class="viewcode-block" id="Pipeline.delete_category"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.delete_category">[docs]</a>    <span class="k">def</span> <span class="nf">delete_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove Category from the pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            *category* (int|str): Category position index or Category name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="n">cat</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="Pipeline.get_index"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the index of a given Category entry from the pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *category* (cat): Category object</span>

<span class="sd">        Returns:</span>
<span class="sd">            | *index* (int): index of Category object in the pipeline</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.process"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process input image selected in UI, save intermediate results in</span>
<span class="sd">        _cache_ and enable pipeline recalculation from the category that was</span>
<span class="sd">        first changed.</span>
<span class="sd">        Keep all intermediate results.</span>
<span class="sd">        &lt;This function will be obviously slower than the console variant due</span>
<span class="sd">        to IO operations on the _cache_ directory.&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reset cache list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># create and set output dir name</span>
        <span class="n">img_fpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">orig_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_fpath</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pip_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span>
                                <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pip_name</span><span class="p">,</span> <span class="n">orig_fname</span><span class="p">]))</span>

        <span class="c1"># check if any algorithm has changed</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cat</span><span class="o">.</span><span class="n">active_algorithm</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
                <span class="n">prev_cat_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">prev_cat_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="n">prev_cat_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">prev_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">break</span>
            <span class="n">prev_cat_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">prev_cat_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">prev_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># decide which category to continue from if any, act accordingly</span>
        <span class="k">if</span> <span class="n">prev_cat_idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># new pipeline, read original img</span>
            <span class="n">orig_arr</span> <span class="o">=</span> <span class="n">read_image_file</span><span class="p">(</span><span class="n">img_fpath</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_memory</span><span class="p">[</span><span class="n">prev_cat_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_arr</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_memory</span><span class="p">[</span><span class="n">prev_cat_idx</span><span class="p">],</span> <span class="bp">None</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_img</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get the results of the previous (unmodified) algorithm</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_memory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prev_cat_idx</span><span class="p">)</span>
            <span class="c1"># remember the prev path</span>
            <span class="n">prev_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_memory</span><span class="p">[</span><span class="n">prev_cat_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># we need to read grayscale if previous category was Segmentation</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_image_file</span><span class="p">(</span><span class="n">prev_path</span><span class="p">,</span> <span class="n">prev_cat_name</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">)</span>

        <span class="c1"># release memory</span>
        <span class="k">if</span> <span class="n">start_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">released</span> <span class="o">=</span> <span class="p">[</span><span class="n">prev_path</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span> <span class="n">prev_cat_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_memory</span><span class="p">[</span><span class="n">prev_cat_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">released</span>
        <span class="c1"># main pipeline loop, execute the pipeline from the modified category</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:],</span> <span class="n">start_idx</span><span class="p">):</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">cat</span><span class="o">.</span><span class="n">active_algorithm</span><span class="o">.</span><span class="n">name</span>
            <span class="n">zope</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">ProgressEvent</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">report</span><span class="p">))</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># reassign results of the prev alg for the next one</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">active_algorithm</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="c1"># check if we have graph</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># draw the graph into the original image</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_utility</span><span class="o">.</span><span class="n">draw_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_img</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># save the results</span>
            <span class="n">save_fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_fname</span><span class="p">(</span><span class="n">img_fpath</span><span class="p">,</span> <span class="n">cat</span><span class="p">)</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">save_fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">save_fname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="c1"># update the cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_cache</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
            <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;_cache_&#39;</span><span class="p">,</span> <span class="n">save_fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_memory</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cat</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="c1"># release memory</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">active_algorithm</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="Pipeline.process_batch"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.process_batch">[docs]</a>    <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a given image or a directory of images using predefined</span>
<span class="sd">        pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_files</span><span class="p">:</span>
            <span class="c1"># create and set output dir name</span>
            <span class="n">orig_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pip_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pip_name</span><span class="p">,</span>
                                                            <span class="n">orig_fname</span><span class="p">]))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_image_file</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="bp">None</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_img</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># process given image with the pipeline</span>
            <span class="n">last_cat</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">:</span>
                <span class="n">cat</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># reassign results of the prev alg for the next one</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">active_algorithm</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
                <span class="n">last_cat</span> <span class="o">=</span> <span class="n">cat</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># draw the graph into the original image</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_utility</span><span class="o">.</span><span class="n">draw_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_img</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># save the results and update the cache if store_image is True</span>
            <span class="n">save_fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_fname</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">last_cat</span><span class="p">)</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">save_fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">save_fname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.save_results"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.save_results">[docs]</a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a directory of the following format: current pipeline + fname.</span>
<span class="sd">        Save and put the results of algorithm processing in the directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *save_path* (str): image save path</span>
<span class="sd">            | *image_name* (str): image name</span>
<span class="sd">            | *results* (list): a list of arguments to save</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if the save directory exists</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="c1"># saving the processed image</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">saved</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR in save_results(), &#39;</span> <span class="o">+</span>
                      <span class="s1">&#39;cv2.imwrite could not save the results!&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR in save_results() &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;Cannot write an image file, make sure there is &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;enough free space on disk&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># exporting graph object</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">image_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">image_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">write_multiline_adjlist</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span>
                                                                <span class="n">image_name</span><span class="p">),</span>
                                       <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="s1">&#39;saved in&#39;</span><span class="p">,</span> <span class="n">dir_to_save</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.sanity_check"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.sanity_check">[docs]</a>    <span class="k">def</span> <span class="nf">sanity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The order of the categories is important in the pipeline.</span>
<span class="sd">        You can not execute graph filtering before graph detection or</span>
<span class="sd">        segmentation after graph filtering (graph filtering requires</span>
<span class="sd">        graph object which only graph detection produces).</span>
<span class="sd">        Therefor we check if the pipeline is in an illegal state before we</span>
<span class="sd">        execute it.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (&quot;&quot;, -1) if the pipeline is NOT in an illegae state,</span>
<span class="sd">            (*message*, i) an error message with the position in pipeline otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Nothing to do.&quot;</span><span class="p">),</span> <span class="mi">0</span>
        <span class="n">pipeline_cats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span>
        <span class="n">is_graph</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">is_segmented</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline_cats</span><span class="p">)):</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">pipeline_cats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;Segmentation&quot;</span> <span class="ow">or</span> <span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;Preprocessing&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_graph</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">((</span><span class="s2">&quot;You cannot process &#39;{0}&#39; after &#39;Graph Detection&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cat</span><span class="p">)),</span> <span class="n">pipeline_cats</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;Graph Detection&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_graph</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">((</span><span class="s2">&quot;You cannot process &#39;{0}&#39; more than once.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cat</span><span class="p">)),</span> <span class="n">pipeline_cats</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;Graph Filtering&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_graph</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">((</span><span class="s2">&quot;You need to process &#39;Graph Detection&#39; before &#39;{0}&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cat</span><span class="p">)),</span> <span class="n">pipeline_cats</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;Graph Detection&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_segmented</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">((</span><span class="s2">&quot;You need to process &#39;Segmentation&#39; before &#39;{0}&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cat</span><span class="p">)),</span> <span class="n">pipeline_cats</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;blank&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">((</span><span class="s2">&quot;Specify step {0} in the pipeline first.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">pipeline_cats</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;Graph Detection&quot;</span><span class="p">:</span>
                <span class="n">is_graph</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="o">==</span> <span class="s2">&quot;Segmentation&quot;</span><span class="p">:</span>
                <span class="n">is_segmented</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Pipeline.report_available_cats"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.report_available_cats">[docs]</a>    <span class="k">def</span> <span class="nf">report_available_cats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_cat</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The order of the categories is important in the pipeline.</span>
<span class="sd">        You can not execute graph filtering before graph detection or</span>
<span class="sd">        segmentation after graph filtering (graph filtering requires</span>
<span class="sd">        graph object which only graph detection produces).</span>
<span class="sd">        When a user selects a category from a drop-down menu we provide only</span>
<span class="sd">        currently allowed categories.</span>

<span class="sd">        Args:</span>
<span class="sd">            *selected_cat* (str): Category selected by the user</span>

<span class="sd">        Returns:</span>
<span class="sd">            a list of currently allowed category names</span>

<span class="sd">        &lt;Deprecated function&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">available_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_available_cats</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">selected_cat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">available_cats</span>
        <span class="k">elif</span> <span class="n">selected_cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_cats</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">available_cats</span>
        <span class="k">elif</span> <span class="n">selected_cat</span> <span class="o">==</span> <span class="s1">&#39;Graph Detection&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">available_cats</span><span class="p">[</span><span class="n">available_cats</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">selected_cat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">available_cats</span><span class="p">[</span><span class="n">available_cats</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">selected_cat</span><span class="p">):]</span></div>

<div class="viewcode-block" id="Pipeline.allow_cat_swap"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.allow_cat_swap">[docs]</a>    <span class="k">def</span> <span class="nf">allow_cat_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the order after potential category swapping and return a bool if</span>
<span class="sd">        it should be allowed or not.</span>

<span class="sd">        Args:</span>
<span class="sd">            |*pos1* (int): position to be swapped</span>
<span class="sd">            |*pos2* (int): position to be swapped</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if allowed and False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_available_cat_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">current_list</span><span class="p">[</span><span class="n">pos1</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_list</span><span class="p">[</span><span class="n">pos2</span><span class="p">]</span></div>

<div class="viewcode-block" id="Pipeline.change_category"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.change_category">[docs]</a>    <span class="k">def</span> <span class="nf">change_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat_name</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the type of the category at position in the executed_cats.</span>
<span class="sd">        This is needed for the ui since the categorys in the executed_cats</span>
<span class="sd">        need to be changed because of the dropdown menus.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *cat_name*: the name of the category as it should be</span>
<span class="sd">            | *position*: the position in the executed_cats</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_cats</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">cat_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.change_algorithm"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.change_algorithm">[docs]</a>    <span class="k">def</span> <span class="nf">change_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the algorithm of the category in position to modified = *True*.</span>
<span class="sd">        Also change the selected algorithm of the category in position.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *position*: list index of the category in the pipeline</span>
<span class="sd">            | *alg_name*: algorithm name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">available_algs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">alg_name</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">set_modified</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">set_active_algorithm</span><span class="p">(</span><span class="n">alg_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.get_executed_cats"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_executed_cats">[docs]</a>    <span class="k">def</span> <span class="nf">get_executed_cats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and return a list of currently executed categories.</span>

<span class="sd">        *No cats are actually harmed during execution of this method &gt;_&lt;*</span>

<span class="sd">        Returns:</span>
<span class="sd">            *executed_cat_names*: list of Category names</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">executed_cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">executed_cat_names</span></div>

<div class="viewcode-block" id="Pipeline.get_category"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_category">[docs]</a>    <span class="k">def</span> <span class="nf">get_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Keys are the names of the categories.</span>

<span class="sd">        Returns:</span>
<span class="sd">            *category*: Category</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_cats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.get_available_cat_names"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_available_cat_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_available_cat_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and return a list of currently loaded categories as strings.</span>
<span class="sd">        Names are used as keys in ``executed_cats`` list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            a list of current Category names in the pipeline</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">]</span></div>

<div class="viewcode-block" id="Pipeline.get_available_cats"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_available_cats">[docs]</a>    <span class="k">def</span> <span class="nf">get_available_cats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and return a list of currently available categories as list of</span>
<span class="sd">        categorie objects.</span>

<span class="sd">        *&lt;Get your cat for free ^-_-^&gt;*</span>

<span class="sd">        Returns:</span>
<span class="sd">            *available_cats*: list of Category classes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">available_cats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_cats</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">available_cats</span></div>

<div class="viewcode-block" id="Pipeline.get_algorithm_list"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_algorithm_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_algorithm_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get names of all available algorithms for the category in position</span>
<span class="sd">        available in the pipeline.</span>
<span class="sd">        Sort the list and return.</span>

<span class="sd">        Args:</span>
<span class="sd">            *position* (int): Category index number</span>

<span class="sd">        Returns:</span>
<span class="sd">            *alg_names* (list): a sorted list of algorithm names</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alg_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">alg_names</span>
        <span class="n">alg_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">alg_names</span></div>

<div class="viewcode-block" id="Pipeline.get_all_algorithm_list"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_all_algorithm_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_algorithm_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get names of all available algorithms for a given category.</span>
<span class="sd">        Sort the list and return.</span>

<span class="sd">        Args:</span>
<span class="sd">            *category*: Category</span>

<span class="sd">        Returns:</span>
<span class="sd">            *alg_names* (list): a sorted list of algorithm names</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alg_names</span> <span class="o">=</span> <span class="n">category</span><span class="o">.</span><span class="n">alg_names</span>
        <span class="n">alg_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">alg_names</span></div>

<div class="viewcode-block" id="Pipeline.get_results_fname"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.get_results_fname">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_fname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_fpath</span><span class="p">,</span> <span class="n">cat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a file name for algorithm results.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *img_fpath* (str): img file path</span>
<span class="sd">            | *cat* (Category): category instance</span>

<span class="sd">        Returns:</span>
<span class="sd">            *img_name* (str): image file name to save</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alg_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="n">active_algorithm</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_fpath</span><span class="p">)</span>
        <span class="n">img_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">cat</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">alg_name</span><span class="p">,</span>
                             <span class="n">basename</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">img_name</span></div>

<div class="viewcode-block" id="Pipeline.set_input"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.set_input">[docs]</a>    <span class="k">def</span> <span class="nf">set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the directory where original images are located or set a file path.</span>

<span class="sd">        Args:</span>
<span class="sd">            *input_source* (str): directory path with original images or a</span>
<span class="sd">            single file path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">input_source</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">filter_images</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_source</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_source</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_source</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;_cache_&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cache</span><span class="p">()</span>
        <span class="n">zope</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">CacheInputEvent</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_source</span><span class="p">),</span> <span class="n">input_source</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_cache_&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.set_output_dir"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.set_output_dir">[docs]</a>    <span class="k">def</span> <span class="nf">set_output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and set the directory where to save the results of processing.</span>
<span class="sd">        &lt;Used in console mode&gt;.</span>

<span class="sd">        Args:</span>
<span class="sd">            *dir_path* (str): directory path for processing results</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">dir_path</span></div>

<div class="viewcode-block" id="Pipeline.load_pipeline_json"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.load_pipeline_json">[docs]</a>    <span class="k">def</span> <span class="nf">load_pipeline_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the Pipeline from the url location and parses all data to</span>
<span class="sd">        create the corresponding executed_cats</span>

<span class="sd">        Args:</span>
<span class="sd">            | *url*: location identifier for the pipeline.json</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">demjson</span><span class="o">.</span><span class="n">decode_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">demjson</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Unable to parse &quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot; trace: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">alg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
            <span class="n">alg_name</span> <span class="o">=</span> <span class="n">alg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">alg_attributes</span> <span class="o">=</span> <span class="n">alg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cat_name</span> <span class="o">=</span> <span class="n">alg_attributes</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_category</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">cat_name</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">)</span>
            <span class="n">active_alg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">active_algorithm</span>
            <span class="n">active_alg</span><span class="o">.</span><span class="n">store_image</span> <span class="o">=</span> <span class="n">alg_attributes</span><span class="p">[</span><span class="s2">&quot;store_image&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">alg_attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;store_image&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">alg_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">active_alg</span><span class="o">.</span><span class="n">find_ui_element</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_path</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1"># reset current cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cache</span><span class="p">()</span></div>

<div class="viewcode-block" id="Pipeline.save_pipeline_json"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.save_pipeline_json">[docs]</a>    <span class="k">def</span> <span class="nf">save_pipeline_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Goes trough the list of executed_cats and calls for every</span>
<span class="sd">        selected_algorithm its report_pip method. With the returned</span>
<span class="sd">        dictionary&#39;s, it builds the pipeline.json file and stores it</span>
<span class="sd">        at the given url location on the file system.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *url*: location identifier for the pipeline.json</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alg_reports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cats</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_active_algorithm</span><span class="p">()</span>
            <span class="n">cat_name</span><span class="p">,</span> <span class="n">alg_dic</span> <span class="o">=</span> <span class="n">alg</span><span class="o">.</span><span class="n">report_pip</span><span class="p">()</span>
            <span class="n">alg_reports</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cat_name</span><span class="p">,</span> <span class="n">alg_dic</span><span class="p">])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;wb+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="c1"># ord_alg_reps = OrderedDict(alg_reports)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">demjson</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">alg_reports</span><span class="p">),</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Pipeline.set_cache"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.set_cache">[docs]</a>    <span class="k">def</span> <span class="nf">set_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create cache dir in order to save in it the intermediate results of</span>
<span class="sd">        processing and an original image.</span>
<span class="sd">        Recreate dir if exists or before running image processing.</span>
<span class="sd">        &lt;This is done to make thumbnails in the left pane available in UI.&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;_cache_&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;_cache_&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR in set_cache() &#39;</span> <span class="o">+</span>
                      <span class="s1">&#39;Cannot remove _cache_ directory, make sure it &#39;</span> <span class="o">+</span>
                      <span class="s1">&#39;is not open or locked by some other process.&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;_cache_&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Pipeline.update_cache"><a class="viewcode-back" href="../../rst_files/Pipeline.html#model.pipeline.Pipeline.update_cache">[docs]</a>    <span class="k">def</span> <span class="nf">update_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy an img to cache dir and update the cache list.</span>

<span class="sd">        Args:</span>
<span class="sd">            | *category*: Category</span>
<span class="sd">            | *img_path* (str): image path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="s1">&#39;_cache_&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR in update_cache() &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;Cannot copy to _cache_ directory, make sure there &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;is enough space on disk&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cache_img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;_cache_&#39;</span><span class="p">,</span>
                                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_path</span><span class="p">))</span>

        <span class="n">zope</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">CacheAddEvent</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">cache_img_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cat</span><span class="p">,</span> <span class="n">cache_img_path</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="ProgressEvent"><a class="viewcode-back" href="../../rst_files/Autogen.html#model.pipeline.ProgressEvent">[docs]</a><span class="k">class</span> <span class="nc">ProgressEvent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event is used to report the progress back to the maincontroller</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">report</span></div>


<div class="viewcode-block" id="CacheAddEvent"><a class="viewcode-back" href="../../rst_files/Autogen.html#model.pipeline.CacheAddEvent">[docs]</a><span class="k">class</span> <span class="nc">CacheAddEvent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event is used to report the maincontroller the new cached image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span></div>


<div class="viewcode-block" id="CacheRemoveEvent"><a class="viewcode-back" href="../../rst_files/Autogen.html#model.pipeline.CacheRemoveEvent">[docs]</a><span class="k">class</span> <span class="nc">CacheRemoveEvent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event is used to report the maincontroller the new cached image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span></div>


<div class="viewcode-block" id="CacheInputEvent"><a class="viewcode-back" href="../../rst_files/Autogen.html#model.pipeline.CacheInputEvent">[docs]</a><span class="k">class</span> <span class="nc">CacheInputEvent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event is used to report the maincontroller the new cached image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_name</span> <span class="o">=</span> <span class="n">image_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Andreas Firczynski, Dennis Gro√ü, Martino Bruni, Pavel Shkadzko, Philipp Reichert, Sebastian Schattner.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>